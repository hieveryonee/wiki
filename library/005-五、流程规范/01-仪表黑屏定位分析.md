# ä»ªè¡¨é»‘å±å®šä½åˆ†æ

## 1 é»‘å±é—®é¢˜éœ€è¦åé¦ˆåŸºæœ¬ä¿¡æ¯ï¼š

é»‘å±é—®é¢˜éœ€è¦åé¦ˆåŸºæœ¬ä¿¡æ¯ï¼š

1ã€ä»ªè¡¨çŠ¶æ€ï¼šæ˜¯å¦é»‘å±ï¼Œæœ‰æ— èƒŒå…‰  
2ã€ä¸­æ§çŠ¶æ€ï¼šæ˜¯å¦é»‘å±ï¼Œæœ‰æ— èƒŒå…‰  
3ã€é—®é¢˜å‘ç”Ÿæ—¶é—´ç‚¹ï¼šç²¾ç¡®åˆ°ç§’ï¼Œæœ€å°‘ç²¾ç¡®åˆ°åˆ†  
4ã€ä¸­æ§ä»ªè¡¨çŠ¶æ€è§†é¢‘  
5ã€Uç›˜log  
6ã€ç‰ˆæœ¬å·  
7ã€å¯ä»¥è¡¥å……ä¸€ä¸‹å½“æ—¶çš„åšäº†é‚£äº›æ“ä½œ  

## 2 é»‘å±é—®é¢˜åˆæ­¥è¯Šæ–­

![img](assets/heiping/å¸¸è§é—®é¢˜æµè½¬.png)

## 3 ä»ªè¡¨å¯åŠ¨æµç¨‹å›¾

![img](assets/heiping/SOCä»ªè¡¨å¯åŠ¨æµç¨‹å›¾.png)


## 4 ä»ªè¡¨æ˜¾ç¤ºå…³é”®è¿›ç¨‹

4.1  ä»ªè¡¨æ˜¾ç¤ºå…³é”®è¿›ç¨‹ï¼š

```
cluster-early-app
EarlyTT
cluster-app
cluster-hmi
```

4.2 åˆ¤æ–­è¿›ç¨‹æ˜¯å¦å­˜åœ¨

```
åœ¨æ€§èƒ½æ—¥å¿—ï¼ˆperf_measurment.txtï¼‰ä¸­æœç´¢è¿›ç¨‹åå­—
```

4.3 åˆ¤æ–­æ˜¯å¦æœ‰core dump

```
ä¸²å£æ—¥å¿—ä¸­(Ser-00000000-xxxx.txt)ä¸­åˆ¤æ–­æ˜¯å¦æœ‰coreæ–‡ä»¶

å…³é”®å­—ï¼š

terminated SIGSEGV                              --- å…·ä½“coreå †æ ˆä¿¡æ¯

dumping to /var/log/EarlyTT.core.gz            --- coreè¿›ç¨‹
```



## 5 å…³é”®ä¿¡å·

### 5.1 ç”µæºä¿¡å·

æ—¥å¿—å…³é”®å­—ï¼šreveice ipk_mode

æœç´¢ç»“æœï¼š   SLOG2_INFO(5) [CLUSTER-APP][PowerProxy] reveice ipk_mode 2

```
enum PowerMode : int {
  PM_SLEEP = 0,
  PM_STARTUP = 1,
  PM_ERROR = 3,
  PM_PREPARE_SHUTDOWN = 4,
  PM_STR = 5,
  PM_REFLASH = 6,
  PM_REMOTE_FOTA = 7,
  PM_SHUTDOWN = 8,
  PM_STR_SUSPENDING = 9,
  PM_WELCOME = 2,
  PM_STARTUP_INACTIVE = 10,
  PM_CONVENIENCE = 11,
  PM_ACTIVE = 12,
  PM_DRIVING = 13,
  PM_KEEP_TOUCH_MODE = 14
};

typedef enum POWER_STATE {
    E_POWER_STATE_ACC_ON,
    E_POWER_STATE_IGN_OFF,
    E_POWER_STATE_IGN_ON,

    E_POWER_STATE_MAX,
    E_POWER_STATE_INVALID,
} E_POWER_STATE;



switch ( mode_in )
{
case com::bosch::cm::housekeeping::pb::susdif::PM_WELCOME:
case com::bosch::cm::housekeeping::pb::susdif::PM_STARTUP_INACTIVE:
case com::bosch::cm::housekeeping::pb::susdif::PM_CONVENIENCE:
case com::bosch::cm::housekeeping::pb::susdif::PM_ACTIVE:
case com::bosch::cm::housekeeping::pb::susdif::PM_DRIVING:
case com::bosch::cm::housekeeping::pb::susdif::PM_KEEP_TOUCH_MODE: {
power_state = E_POWER_STATE_IGN_ON;
break;
}
case com::bosch::cm::housekeeping::pb::susdif::PM_SLEEP: {
power_state = E_POWER_STATE_IGN_OFF;
break;
}
case com::bosch::cm::housekeeping::pb::susdif::PM_SHUTDOWN: {
power_state = E_POWER_STATE_ACC_ON;
break;
}
```

### 5.2 Usagemodeä¿¡å·

```
/* Usage mode */
#define USGMODE_ABANDONNED  0
#define USGMODE_INACTIVE    1
#define USGMODE_CONVENIENCE 2
#define USGMODE_ACTIVE      11
#define USGMODE_DRIVING     13

### SOC æ”¶åˆ°UsageModeä¿¡å·
å…³é”®å­—ï¼šSetUsageModeMsg mCanValue

SLOG2_INFO(5) [STARTUP][IlluminationSvr] SetUsageModeMsg mCanValue = 1, mCanState = 0

### hmi æ”¶åˆ°usagemode
cluster.hmistate [INFO] HMIState UsagModeNotify:: mRcvUsageMode

[CLUSTER-APP]cluster.hmistate [INFO] HMIState UsagModeNotify:: mRcvUsageMode 13

```

### 5.3 èƒŒå…‰ä¿¡å·

```
SLOG2_INFO(5) [STARTUP][IlluminationSvr] SetDisplayStatus, display_type: 2, back_light: 0
```

### 5.4 å¼€æœºåŠ¨ç”»

```
E_CLUSTER_ANIMATION_STATUS = 0 è¡¨ç¤ºä¸æ˜¾ç¤ºHMIï¼Œå¦åˆ™æ˜¾ç¤ºHMI

# HMI æ—¥å¿—
LOG2_INFO(5) [ICFN][HMISTATE] ClusterAnimationStatusNotify: 0

æšä¸¾å€¼ï¼š
typedef enum CLUSTER_ANIMATION_STATUS {
    E_ANIMATION_STATUS_NOT_START = 0,
    E_ANIMATION_STATUS_PLAYING,
    E_ANIMATION_STATUS_PLAY_END,
    E_ANIMATION_STATUS_BREAK,
    E_ANIMATION_STATUS_TIMEOUT,
} E_CLUSTER_ANIMATION_STATUS;
```

### 5.5 TTè‡ªæ£€

```
# å®ŒæˆTTè‡ªæ£€æ—¥å¿—  

UpdateState send CheckDone after HMI ready
```

### 5.6 å°æ†©æ¨¡å¼ã€gameæ¨¡å¼

```
åŸå› ï¼š      å¯èƒ½æ˜¯HMIè®©å‡ºäº†ç•Œé¢ï¼Œè®©ä¸­æ§æŠ•å±ï¼Œä½†æ˜¯ä¸­æ§åˆæ²¡æœ‰æŠ•å±å¯¼è‡´ã€‚
æ¶‰åŠæ¨¡å—ï¼š  æ‰“æ°´æ¼‚gameæ¨¡å¼ï¼Œå°æ†©æ¨¡å¼
ä¿¡å·ï¼š      SettingModule.SetIVIMsg Send mGameDisp:


1ã€HMI åœ¨è¿™ä¸ªæ—¶é—´æ®µæ”¶åˆ°äº† game çš„æ¶ˆæ¯ï¼Œè®©HMI éšè—
2023-04-20 21:49:50.215         CMW_Cluster.786504..4       239    4     SLOG2_INFO(5) [EarlyTT]HMITT NORMAL SettingGameDisplay 1
2023-04-20 21:49:50.215         CMW_Cluster.798812..1      1516    7     SLOG2_INFO(5) [ICFN]zhanghao [HMISTATE]SettingGameDisplay-In: 1


2ã€HMI åœ¨è¿™ä¸ªæ—¶é—´æ®µæ”¶åˆ°äº† game çš„æ¶ˆæ¯ï¼Œè®©HMI æ˜¾ç¤º
2023-04-20 21:52:16.648         CMW_Cluster.786504..4       338    4     SLOG2_INFO(5) [EarlyTT]HMITT NORMAL SettingGameDisplay 0

2023-04-20 21:52:16.648         CMW_Cluster.798812..1      4989    7     SLOG2_INFO(5) [ICFN]zhanghao [HMISTATE]SettingGameDisplay-In: 0
```

## 6 åšä¸–å¯åŠ¨ä»ªè¡¨è„šæœ¬startup

 ```
# cat /usr/etc/slm/SLM_Cluster.xml

<SLM:component name="cluster">
    <SLM:envvar>TEST=/apps/</SLM:envvar>
    <SLM:envvar>TEST=/apps/cluster</SLM:envvar>
    <SLM:command>/bin/on</SLM:command>
    <SLM:args>/apps/cluster/common/bin/startup</SLM:args>
    <SLM:depend>screen_ready</SLM:depend>
    <SLM:depend>early_cluster_ready</SLM:depend>
    <SLM:waitfor wait="exits"></SLM:waitfor>
    <SLM:repair>none</SLM:repair>
    <SLM:user>root:root</SLM:user>
    <SLM:type>default_root_t</SLM:type>
    <SLM:stdout>/dev/null</SLM:stdout>
    <SLM:stderr>/dev/null</SLM:stderr>
</SLM:component>

 ```



## 7 SOCå„ä¸ªè¿›ç¨‹å’Œæ‰€å±åŸŸåˆ†å¸ƒ

| Appåç§°             | å½’å±åŸŸ  |
| ----------------- | -------- |
| apa-app-arc       | pVideo   |      
| pac-app           | pVideo   |      
| cluster-early-app | pCluster |      
| EarlyTT           | pCluster |      
| cluster-app       | pCluster |      
| welcomeshow-anim  | pVideo   |      
| cluster-anim      | pVideo   |      
| psd-anim          | pVideo   |      
| ivi-anim          | pAndroid |      
| ParkingAssist-hmi | pCluster |      
| hvac-hmi          | pVideo   |      
| hvac-app          | pVideo   |      
| cluster-bg-hmi    | pCluster |      
| hud-hmi           | pCluster |      
| dms2-app          | pVideo   |      
| FUSA              | System   |      
| FUSA-ONEOS        | System   |      
| UpdateService     | System   |      
| system-monitor    | pCluster |      

## 8 è¿›ç¨‹core dumpåˆ†æ

```
ç¬¬ä¸€æ­¥ï¼šä»è½¦æœºç¯å¢ƒä¸Šå¯¼å‡º  /apps/cluster/FX11_HEV/lib  ç›®å½•ä¸‹æ‰€æœ‰çš„libæ–‡ä»¶
æˆ–è€…é€šè¿‡SOC/release ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„libæ–‡ä»¶

ç¬¬äºŒæ­¥ï¼šå‘åšä¸–è·å–å¯¹åº”çš„å¸¦æœ‰ç¬¦å·è¡¨çš„ä½åŒ…ï¼Œå¦‚ rb-ecarx-dhu_hqx121c1-pcs03_fx11-ota3_release_2023.22.3_userdebug_qnx_symbols.tar

è§£å‹åç›®å½•ï¼š
UpdateService.core  --- è¦è§£çš„core  
rb-ecarx-dhu        --- åšä¸–ç¬¦å·è¡¨  rb-ecarx-dhu_hqx121c1-pcs03_oneos-g636-sop_release_2023.22.3_userdebug_qnx_symbols.tar
lib                 --- è½¦è”libåº“

ä»¥æ­¤è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š  

# /opt/qnx/qnx700_hqx1.2.1/host/linux/x86_64/usr/bin/ntoaarch64-gdb -c early_boot_cluster-app.core

# set solib-search-path ./lib:rb-ecarx-dhu/qnx_sym/lib:rb-ecarx-dhu/qnx_sym/usr/lib

# bt

```

![img](assets/heiping/core dump1.png)

![img](assets/heiping/core dump2.png)



## 9 å†…å­˜åˆ†æ

ç›¸å…³å‘½ä»¤

```
#pidin -f adA  

3530856 2820K id.car.settings  
3653726   70M ./hud-hmi  
3653750  231M ./dms2-app  
3739746 4496K droid.launcher3  
3776664 2884K ndroid.systemui  
3821710 1788K ultiprocessapp1  
4714572 1788K com.geely.hvac  
4726873 2820K du.che.codriver  
4763748 1788K tonavi.amapauto  
....

```

```
# showmem -s

                 Mem	  Total(KB)	   Used(KB)	   Free(KB)
-------------------------------------------------------------------
              sysram	    1798252	    1205128	     593124
          gvm_secmem	     331776	          0	     331776
            gvm_pmem	     512000	        116	     511884
           adsp_heap	       9216	          0	       9216
                qcpe	      99328	      99328	          0
             cvp_mem	      10240	       2408	       7832
             mdf_mem	      10240	          0	      10240
           mdsp_frpc	      10240	          0	      10240
             QSEECOM	      20480	       6472	      14008
              mm_dma	    2129920	     650948	    1478972
          smmu_s1_pt	      16384	       5300	      11084
                 dma	     163840	      81332	      82508

```

```
# showmem
```

![img](assets/heiping/showmem.png)

## 10 CUPå ç”¨ç‡åˆ†æ

```
# aps

Partition name   id | Budget |   Max  |   Used | Budget |   Used
--------------------+------------------------+---------------------
System            0 |  20.0% | 100.0% | 22.04% |  800ms |   0.000ms
pAudio            1 |  10.0% |  30.0% |  3.33% |  100ms |   0.000ms
pVideo            2 |  10.0% |  30.0% |  1.95% |  100ms |   0.000ms
pCluster          3 |  10.0% |  15.0% |  4.06% |  100ms |   0.000ms
pAndroid          4 |  50.0% |  85.0% | 36.07% |  100ms |   0.000ms
--------------------+------------------------+---------------------
Total               | 100.0% |        | 67.44% |
```

```
# hogs

 PID           NAME       MSEC  PIDS SYS      MEMORY
    86062     ais_server   301   1%  10%   3564k   0%
    40981    spi_service   341   1%  11%   1028k   0%
        1 procnto-smp-in   358   1%  11%      0k   0%
148160617        hud-hmi   359   1%  11%  18160k   2%
  1208441    log_storage   377   1%  12%   4596k   0%
    49187     wfd_server   381   1%  12%   2304k   0%
148156518    cluster-hmi   451   1%  15%  56308k   7%
148688983       FX11_HEV   501   2%  16%  72056k   9%
   118837 vehicleservice   603   2%  20%  25264k   3%
    45078           pipe   603   2%  20%    680k   0%
    53293  audio_service   634   2%  21%   5280k   0%
  1601673            qvm 10041  41% 334%   4904k   0%
```

```
# top -b -t -z 40

   PID   TID PRI STATE    HH:MM:SS    CPU  COMMAND[K
  1601673     7  10 Run       2:47:40   8.58% qvm.virtual cpu la/5[K
  1601673     6  10 Run       2:54:58   7.86% qvm.virtual cpu la/4[K
  1601673     5  10 Sem       2:10:48   5.90% qvm.virtual cpu la/3[K
  1601673     3  10 Sem       2:04:39   5.45% qvm.virtual cpu la/1[K
  1601673     2  10 Run       2:13:09   5.15% qvm.virtual cpu la/0[K
  1601673     4  10 Sem       2:06:29   4.63% qvm.virtual cpu la/2[K
   118837    11  30 SigW      1:01:29   2.53% vehicleservice.IncVdataListener[K
  1208441     7  10 NSlp      0:35:22   1.44% log_storage[K
148156518     1  15 NSlp      0:14:36   1.23% cluster-hmi[K
    53293    23  29 CdV       0:15:58   0.93% audio_service.CSD_AS_WLOOP[K
    53293    13  45 Intr      0:20:29   0.93% audio_service.GLINK_IST_188[K
        1    20  75 Rcv       0:00:03   0.88% kernel[K
148160617     1  15 NSlp      0:05:35   0.88% hud-hmi[K
```

```
# pidin thread | grep cluster-app
```

![img](assets/heiping/thread_info.png)
